<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grant Portfolio Evaluator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
      color: #1a1a1a;
    }

    .container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background-color: #0d7377;
      color: white;
      padding: 30px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      text-align: center;
    }

    header h1 {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.5px;
      margin-bottom: 8px;
    }

    header p {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 12px;
    }

    .header-attribution {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 8px;
    }

    .header-attribution a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      border-bottom: 1px solid rgba(255,255,255,0.5);
      transition: border-color 0.2s;
    }

    .header-attribution a:hover {
      border-bottom-color: white;
    }

    main {
      flex: 1;
      padding: 30px;
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
    }

    .intro-section {
      background: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 30px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      line-height: 1.6;
      color: #6b7280;
      font-size: 14px;
    }

    .intro-section h2 {
      color: #0d7377;
      margin-bottom: 12px;
      font-size: 16px;
    }

    .intro-section strong {
      color: #1a1a1a;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
      flex-wrap: wrap;
    }

    .tab-button {
      padding: 12px 16px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: #9ca3af;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab-button.active {
      color: #0d7377;
      border-bottom-color: #0d7377;
    }

    .tab-button:hover {
      color: #0d7377;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .proposal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .proposal-card {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border-top: 4px solid #0d7377;
    }

    .proposal-card.card-2 {
      border-top-color: #14a085;
    }

    .proposal-card.card-3 {
      border-top-color: #ff8c42;
    }

    .proposal-title {
      font-size: 18px;
      font-weight: 700;
      color: #0d7377;
      margin-bottom: 20px;
    }

    .param-group {
      margin-bottom: 20px;
    }

    .param-label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: block;
    }

    .param-value {
      font-size: 20px;
      font-weight: 700;
      color: #0d7377;
      margin-bottom: 8px;
    }

    .param-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 4px;
    }

    input[type="range"] {
      width: 100%;
      accent-color: #0d7377;
    }

    input[type="number"] {
      font-family: 'Courier New', monospace;
    }

    input[type="text"] {
      width: 100%;
    }

    .param-hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
      font-style: italic;
    }

    .calc-explanation {
      background: #f0f9f8;
      border-left: 3px solid #0d7377;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      color: #1a1a1a;
      margin-top: 8px;
      line-height: 1.4;
    }

    .breakeven-alert {
      background: #fff3e0;
      border-left: 4px solid #ff8c42;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      color: #1a1a1a;
      margin-top: 8px;
    }

    .breakeven-alert.positive {
      background: #e8f5e9;
      border-left-color: #388e3c;
    }

    .comparison-table {
      width: 100%;
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 30px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 700;
      color: #6b7280;
      border-bottom: 2px solid #e5e7eb;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.5px;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .metric-value {
      font-weight: 700;
      color: #0d7377;
    }

    .metric-negative {
      color: #d32f2f;
    }

    .metric-positive {
      color: #388e3c;
    }

    .metric-warning {
      color: #ff8c42;
    }

    .key-insight {
      background: linear-gradient(135deg, #f0f9f8 0%, #e8f5f2 100%);
      border-left: 4px solid #0d7377;
      border-radius: 4px;
      padding: 16px;
      margin-bottom: 20px;
      font-size: 13px;
      line-height: 1.6;
      color: #1a1a1a;
    }

    .key-insight strong {
      color: #0d7377;
    }

    .grant-tier {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      border-left: 6px solid #0d7377;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .grant-tier.core {
      border-left-color: #388e3c;
      background: #f7fdfb;
    }

    .grant-tier.opportunistic {
      border-left-color: #0d7377;
      background: #f0f9f8;
    }

    .grant-tier.exploratory {
      border-left-color: #ff8c42;
      background: #fffbf7;
    }

    .grant-tier.skip {
      border-left-color: #d32f2f;
      background: #fff5f5;
    }

    .tier-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .tier-badge.core {
      background: #388e3c;
      color: white;
    }

    .tier-badge.opportunistic {
      background: #0d7377;
      color: white;
    }

    .tier-badge.exploratory {
      background: #ff8c42;
      color: white;
    }

    .tier-badge.skip {
      background: #d32f2f;
      color: white;
    }

    .tier-title {
      font-size: 14px;
      font-weight: 700;
      color: #0d7377;
      margin-bottom: 10px;
    }

    .grant-tier.core .tier-title {
      color: #388e3c;
    }

    .grant-tier.exploratory .tier-title {
      color: #ff8c42;
    }

    .grant-tier.skip .tier-title {
      color: #d32f2f;
    }

    .tier-description {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 10px;
      line-height: 1.5;
    }

    .tier-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      font-size: 12px;
      margin-top: 10px;
    }

    .tier-metric {
      background: white;
      padding: 8px;
      border-radius: 4px;
      border-left: 3px solid #d1d5db;
    }

    .tier-metric-label {
      font-size: 10px;
      color: #9ca3af;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .tier-metric-value {
      font-weight: 700;
      color: #0d7377;
      font-size: 14px;
    }

    .ranking-index {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    .ranking-row {
      display: grid;
      grid-template-columns: 60px 1fr 120px 120px 140px 140px 140px;
      gap: 12px;
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      align-items: center;
      border-radius: 4px;
    }

    .ranking-row.core {
      background: #f7fdfb;
      border-left: 4px solid #388e3c;
    }

    .ranking-row.opportunistic {
      background: #f0f9f8;
      border-left: 4px solid #0d7377;
    }

    .ranking-row.exploratory {
      background: #fffbf7;
      border-left: 4px solid #ff8c42;
    }

    .ranking-row.skip {
      background: #fff5f5;
      border-left: 4px solid #d32f2f;
    }

    .ranking-number {
      font-size: 24px;
      font-weight: 700;
      color: #0d7377;
      text-align: center;
    }

    .ranking-name {
      font-weight: 600;
      color: #1a1a1a;
    }

    .ranking-metric {
      text-align: center;
      font-size: 12px;
    }

    .ranking-metric-label {
      font-size: 9px;
      color: #9ca3af;
      text-transform: uppercase;
      margin-bottom: 4px;
      letter-spacing: 0.5px;
    }

    .ranking-metric-value {
      font-size: 15px;
      font-weight: 700;
      color: #0d7377;
    }

    .tier-tag {
      text-align: center;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .tier-tag.core {
      background: #388e3c;
      color: white;
    }

    .tier-tag.opportunistic {
      background: #0d7377;
      color: white;
    }

    .tier-tag.exploratory {
      background: #ff8c42;
      color: white;
    }

    .tier-tag.skip {
      background: #d32f2f;
      color: white;
    }

    .portfolio-summary {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    .portfolio-summary h3 {
      color: #0d7377;
      margin-bottom: 16px;
      font-size: 16px;
      font-weight: 700;
    }

    .portfolio-chart-container {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    .portfolio-chart-container h4 {
      color: #0d7377;
      margin-bottom: 16px;
      font-size: 14px;
      font-weight: 700;
    }

    #portfolioChart {
      max-height: 120px;
      margin-bottom: 16px;
    }

    .chart-legend {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    .chart-legend-item {
      display: flex;
      align-items: center;
      font-size: 12px;
    }

    .chart-legend-color {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      margin-right: 8px;
    }

    .chart-legend-color.core {
      background: #388e3c;
    }

    .chart-legend-color.opportunistic {
      background: #0d7377;
    }

    .chart-legend-color.exploratory {
      background: #ff8c42;
    }

    .chart-legend-color.skip {
      background: #d32f2f;
    }
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    .portfolio-item {
      padding: 16px;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 4px solid #0d7377;
    }

    .portfolio-item.opportunistic {
      border-left-color: #0d7377;
    }

    .portfolio-item.exploratory {
      border-left-color: #ff8c42;
    }

    .portfolio-item.skip {
      border-left-color: #d32f2f;
    }

    .portfolio-label {
      font-size: 11px;
      font-weight: 700;
      color: #9ca3af;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .portfolio-value {
      font-size: 24px;
      font-weight: 700;
      color: #0d7377;
      margin-bottom: 4px;
    }

    .portfolio-item.opportunistic .portfolio-value {
      color: #0d7377;
    }

    .portfolio-item.exploratory .portfolio-value {
      color: #ff8c42;
    }

    .portfolio-item.skip .portfolio-value {
      color: #d32f2f;
    }

    .portfolio-description {
      font-size: 12px;
      color: #6b7280;
    }

    .framework-section {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-top: 30px;
    }

    .framework-section h3 {
      font-size: 16px;
      font-weight: 700;
      color: #0d7377;
      margin-bottom: 16px;
    }

    footer {
      background-color: #1a1a1a;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 12px;
      line-height: 1.8;
    }

    @media (max-width: 1200px) {
      .proposal-grid {
        grid-template-columns: 1fr 1fr;
      }
      .ranking-row {
        grid-template-columns: 1fr;
      }
      .ranking-metric {
        display: inline-block;
        margin-right: 16px;
      }
      .portfolio-grid {
        grid-template-columns: 1fr 1fr;
      }
      .chart-legend {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      header h1 {
        font-size: 24px;
      }
      header > div > div {
        flex-direction: column;
        align-items: flex-start !important;
      }
      .proposal-grid {
        grid-template-columns: 1fr;
      }
      main {
        padding: 15px;
      }
      .portfolio-grid {
        grid-template-columns: 1fr;
      }
      .chart-legend {
        grid-template-columns: 1fr;
      }
      .tier-metrics {
        grid-template-columns: 1fr;
      }
      .intro-section > div > div {
        grid-template-columns: 1fr !important;
      }
      table {
        font-size: 12px;
      }
      th, td {
        padding: 8px !important;
      }
      .tabs {
        flex-wrap: wrap;
      }
      .tab-button {
        padding: 10px 12px;
        font-size: 12px;
      }
      .framework-section > div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
      }
    }

    @media (max-width: 480px) {
      header h1 {
        font-size: 20px;
      }
      header p {
        font-size: 12px;
      }
      .param-value {
        font-size: 16px;
      }
      .ranking-number {
        font-size: 18px;
      }
      .key-insight {
        padding: 12px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="max-width: 1600px; margin: 0 auto;">
        <h1>Grant Portfolio Evaluator</h1>
        <p>Rank and prioritize research funding opportunities with persistence-aware analysis</p>
        <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
          <div>
            <span style="font-size: 14px;">Created by <strong style="font-size: 15px;">James McInerney</strong></span>
            <a href="https://github.com/mol-evol" target="_blank" rel="noopener noreferrer" style="display: inline-block; margin-left: 12px; padding: 6px 14px; background: rgba(255,255,255,0.15); color: white; text-decoration: none; border-radius: 4px; font-size: 13px; font-weight: 600; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
              GitHub: mol-evol
            </a>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <span style="font-size: 12px; opacity: 0.8; margin-right: 4px;">Share:</span>
            <a href="https://www.linkedin.com/sharing/share-offsite/?url=" onclick="this.href='https://www.linkedin.com/sharing/share-offsite/?url='+encodeURIComponent(window.location.href)" target="_blank" rel="noopener noreferrer" title="Share on LinkedIn" style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: rgba(255,255,255,0.15); border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
            </a>
            <a href="https://bsky.app/intent/compose?text=" onclick="this.href='https://bsky.app/intent/compose?text='+encodeURIComponent('Grant Portfolio Evaluator - rank and prioritize research funding opportunities ' + window.location.href)" target="_blank" rel="noopener noreferrer" title="Share on Bluesky" style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: rgba(255,255,255,0.15); border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.166 6.839 9.489.5.092.682-.217.682-.482 0-.237-.009-.866-.013-1.7-2.782.603-3.369-1.342-3.369-1.342-.454-1.155-1.11-1.462-1.11-1.462-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.163 22 16.418 22 12c0-5.523-4.477-10-10-10z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=" onclick="this.href='https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(window.location.href)" target="_blank" rel="noopener noreferrer" title="Share on Facebook" style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: rgba(255,255,255,0.15); border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
            </a>
            <a href="mailto:?subject=Grant%20Portfolio%20Evaluator&body=" onclick="this.href='mailto:?subject=Grant%20Portfolio%20Evaluator&body='+encodeURIComponent('Check out this grant portfolio evaluator: ' + window.location.href)" title="Share via Email" style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: rgba(255,255,255,0.15); border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
            </a>
            <a href="#" onclick="navigator.clipboard.writeText(window.location.href); this.innerHTML='<svg width=\'18\' height=\'18\' viewBox=\'0 0 24 24\' fill=\'white\'><path d=\'M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z\'/></svg>'; setTimeout(() => this.innerHTML='<svg width=\'18\' height=\'18\' viewBox=\'0 0 24 24\' fill=\'white\'><path d=\'M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z\'/></svg>', 2000); return false;" title="Copy link" style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: rgba(255,255,255,0.15); border-radius: 4px; transition: background 0.2s; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
            </a>
          </div>
        </div>
      </div>
    </header>

    <main>
      <div class="intro-section">
        <h2>How This Framework Works</h2>
        <p>Grant writing is fundamentally different from gambling. You don't go bankrupt—you run out of time. And you must submit proposals repeatedly to eventually succeed. This evaluator recognizes that reality.</p>
        <p style="margin-top: 12px;"><strong>Key insight:</strong> Most proposals will be rejected. Success requires persistence. So we rank proposals by their <strong>effective commitment level</strong>—accounting for both how efficient they are AND how many times you're willing to resubmit. A high-value proposal you'd only submit once ranks lower than a medium-value proposal you'd iterate on multiple times.</p>
        <p style="margin-top: 12px;">The evaluator assigns each proposal to a tier—<strong>Core, Opportunistic, Exploratory, or Skip</strong>—based on efficiency and your realistic commitment.</p>
        
        <div style="background: #f0f9f8; border-left: 4px solid #0d7377; padding: 12px; border-radius: 4px; margin-top: 16px;">
          <label style="font-size: 12px; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 12px;">
            Research Time Allocation Strategy
          </label>
          <div class="settings-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div>
              <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 6px;">
                Currency
              </label>
              <select id="currencySelect" onchange="updateAll()" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; font-weight: 700;">
                <option value="$">USD ($)</option>
                <option value="£" selected>GBP (£)</option>
                <option value="€">EUR (€)</option>
                <option value="¥">CNY (¥)</option>
                <option value="R$">BRL (R$)</option>
                <option value="¥">JPY (¥)</option>
                <option value="₹">INR (₹)</option>
                <option value="AUD">AUD (AUD)</option>
                <option value="CAD">CAD (CAD)</option>
              </select>
            </div>
            <div>
              <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 6px;">
                Total Annual Research Hours
              </label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="number" id="totalResearchHours" value="2000" min="500" step="100" style="width: 100px; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; font-weight: 700; font-family: 'Courier New', monospace;">
                <span style="font-size: 13px; color: #6b7280;">hours/year</span>
              </div>
              <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">Research, teaching, admin, mentoring</div>
            </div>
            <div>
              <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 6px;">
                % to Allocate to Grant Writing
              </label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="number" id="grantWritingPercent" value="20" min="5" max="100" step="5" style="width: 70px; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; font-weight: 700; font-family: 'Courier New', monospace;">
                <span style="font-size: 13px; color: #6b7280;">%</span>
                <span id="grantHoursDisplay" style="font-size: 13px; color: #0d7377; font-weight: 700; margin-left: 8px;">= 400 h/year</span>
              </div>
              <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">Your strategic choice for grant proposals</div>
            </div>

            <div>
              <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 6px;">
                Your Target Hourly Value
              </label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <span id="targetCurrencySymbol" style="font-size: 13px; color: #6b7280;">£</span>
                <input type="number" id="targetHourlyValue" value="1500" min="100" step="100" style="width: 100px; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; font-weight: 700; font-family: 'Courier New', monospace;">
                <span style="font-size: 13px; color: #6b7280;">/hour</span>
              </div>
              <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">Szilard threshold: pursue if EV/hr exceeds this</div>
            </div>
          </div>
      </div>

      <div class="tabs">
        <button class="tab-button active" onclick="switchTab('input')">Input Proposals</button>
        <button class="tab-button" onclick="switchTab('ranking')">Portfolio Ranking</button>
        <button class="tab-button" onclick="switchTab('guidance')">Submission Strategy</button>
        <button class="tab-button" onclick="switchTab('framework')">Guide</button>
      </div>

      <!-- INPUT TAB -->
      <div id="input" class="tab-content active">
        <div class="proposal-grid">
          <div class="proposal-card">
            <div class="proposal-title">Proposal 1</div>

            <div class="param-group">
              <label class="param-label">Name/Description</label>
              <input type="text" class="param-input" id="p1-name" value="Turing Fellowship" onchange="updateAll()">
            </div>

            <div class="param-group">
              <label class="param-label">Award Amount (<span id="p1-currency-label">£</span>)</label>
              <div class="param-value" id="p1-award-display">£2.5M</div>
              <input type="range" class="param-input" id="p1-award" min="50000" max="5000000" step="50000" value="2500000" oninput="syncFromSlider('p1-award', 'p1-award-num'); updateDisplay('p1'); updateAll()">
              <input type="number" class="param-input" id="p1-award-num" min="0" step="10000" value="2500000" oninput="syncFromNumber('p1-award', 'p1-award-num'); updateDisplay('p1'); updateAll()">
            </div>

            <div class="param-group">
              <label class="param-label">Estimated Hours per Submission</label>
              <div class="param-value" id="p1-hours-display">80h</div>
              <input type="range" class="param-input" id="p1-hours" min="5" max="500" step="5" value="80" oninput="syncFromSlider('p1-hours', 'p1-hours-num'); updateDisplay('p1'); updateAll()">
              <input type="number" class="param-input" id="p1-hours-num" min="1" step="1" value="80" oninput="syncFromNumber('p1-hours', 'p1-hours-num'); updateDisplay('p1'); updateAll()">
            </div>

            <div class="param-group">
              <label class="param-label">Success Probability (%)</label>
              <div class="param-value" id="p1-prob-display">20%</div>
              <input type="range" class="param-input" id="p1-prob" min="1" max="100" step="1" value="20" oninput="syncFromSlider('p1-prob', 'p1-prob-num'); updateDisplay('p1'); updateAll()">
              <input type="number" class="param-input" id="p1-prob-num" min="0.1" max="100" step="0.1" value="20" oninput="syncFromNumber('p1-prob', 'p1-prob-num'); updateDisplay('p1'); updateAll()">
              <div class="param-hint">Honest estimate. Include competitive pressure.</div>
              <div class="calc-explanation" id="p1-calc"></div>
              <div class="breakeven-alert" id="p1-breakeven"></div>
            </div>

            <div class="param-group">
              <label class="param-label">Strategic Value Multiplier (1-3x)</label>
              <div class="param-value" id="p1-mult-display">1.0x</div>
              <input type="range" class="param-input" id="p1-mult" min="1" max="3" step="0.1" value="1.0" oninput="syncFromSlider('p1-mult', 'p1-mult-num'); updateDisplay('p1'); updateAll()">
              <input type="number" class="param-input" id="p1-mult-num" min="0.1" max="10" step="0.1" value="1.0" oninput="syncFromNumber('p1-mult', 'p1-mult-num'); updateDisplay('p1'); updateAll()">
              <div class="param-hint">Relationship building, leadership visibility, downstream grants?</div>
            </div>

            <div class="param-group">
              <label class="param-label">Max Attempts</label>
              <div class="param-value" id="p1-resubmit-display">3</div>
              <input type="range" class="param-input" id="p1-resubmit" min="1" max="10" step="1" value="3" oninput="syncFromSlider('p1-resubmit', 'p1-resubmit-num'); updateDisplay('p1'); updateAll()">
              <input type="number" class="param-input" id="p1-resubmit-num" min="1" step="1" value="3" oninput="syncFromNumber('p1-resubmit', 'p1-resubmit-num'); updateDisplay('p1'); updateAll()">
              <div class="param-hint">Total times you'd submit this (including the first attempt)</div>
              <div class="calc-explanation" id="p1-resubmit-calc"></div>
            </div>
          </div>

          <div class="proposal-card card-2">
            <div class="proposal-title">Proposal 2</div>

            <div class="param-group">
              <label class="param-label">Name/Description</label>
              <input type="text" class="param-input" id="p2-name" value="BBSRC Responsive-Mode" onchange="updateAll()">
            </div>

            <div class="param-group">
              <label class="param-label">Award Amount (<span id="p2-currency-label">£</span>)</label>
              <div class="param-value" id="p2-award-display">£900k</div>
              <input type="range" class="param-input" id="p2-award" min="50000" max="5000000" step="50000" value="900000" oninput="syncFromSlider('p2-award', 'p2-award-num'); updateDisplay('p2'); updateAll()">
              <input type="number" class="param-input" id="p2-award-num" min="0" step="10000" value="900000" oninput="syncFromNumber('p2-award', 'p2-award-num'); updateDisplay('p2'); updateAll()">
            </div>

            <div class="param-group">
              <label class="param-label">Estimated Hours per Submission</label>
              <div class="param-value" id="p2-hours-display">60h</div>
              <input type="range" class="param-input" id="p2-hours" min="5" max="500" step="5" value="60" oninput="syncFromSlider('p2-hours', 'p2-hours-num'); updateDisplay('p2'); updateAll()">
              <input type="number" class="param-input" id="p2-hours-num" min="1" step="1" value="60" oninput="syncFromNumber('p2-hours', 'p2-hours-num'); updateDisplay('p2'); updateAll()">
            </div>

            <div class="param-group">
              <label class="param-label">Success Probability (%)</label>
              <div class="param-value" id="p2-prob-display">20%</div>
              <input type="range" class="param-input" id="p2-prob" min="1" max="100" step="1" value="20" oninput="syncFromSlider('p2-prob', 'p2-prob-num'); updateDisplay('p2'); updateAll()">
              <input type="number" class="param-input" id="p2-prob-num" min="0.1" max="100" step="0.1" value="20" oninput="syncFromNumber('p2-prob', 'p2-prob-num'); updateDisplay('p2'); updateAll()">
              <div class="param-hint">Honest estimate. Include competitive pressure.</div>
              <div class="calc-explanation" id="p2-calc"></div>
              <div class="breakeven-alert" id="p2-breakeven"></div>
            </div>

            <div class="param-group">
              <label class="param-label">Strategic Value Multiplier (1-3x)</label>
              <div class="param-value" id="p2-mult-display">1.0x</div>
              <input type="range" class="param-input" id="p2-mult" min="1" max="3" step="0.1" value="1.0" oninput="syncFromSlider('p2-mult', 'p2-mult-num'); updateDisplay('p2'); updateAll()">
              <input type="number" class="param-input" id="p2-mult-num" min="0.1" max="10" step="0.1" value="1.0" oninput="syncFromNumber('p2-mult', 'p2-mult-num'); updateDisplay('p2'); updateAll()">
              <div class="param-hint">Relationship building, leadership visibility, downstream grants?</div>
            </div>

            <div class="param-group">
              <label class="param-label">Max Attempts</label>
              <div class="param-value" id="p2-resubmit-display">3</div>
              <input type="range" class="param-input" id="p2-resubmit" min="1" max="10" step="1" value="3" oninput="syncFromSlider('p2-resubmit', 'p2-resubmit-num'); updateDisplay('p2'); updateAll()">
              <input type="number" class="param-input" id="p2-resubmit-num" min="1" step="1" value="3" oninput="syncFromNumber('p2-resubmit', 'p2-resubmit-num'); updateDisplay('p2'); updateAll()">
              <div class="param-hint">Total times you'd submit this (including the first attempt)</div>
              <div class="calc-explanation" id="p2-resubmit-calc"></div>
            </div>
          </div>

          <div class="proposal-card card-3">
            <div class="proposal-title">Proposal 3</div>

            <div class="param-group">
              <label class="param-label">Name/Description</label>
              <input type="text" class="param-input" id="p3-name" value="Small Charity" onchange="updateAll()">
            </div>

            <div class="param-group">
              <label class="param-label">Award Amount (<span id="p3-currency-label">£</span>)</label>
              <div class="param-value" id="p3-award-display">£50k</div>
              <input type="range" class="param-input" id="p3-award" min="50000" max="5000000" step="50000" value="50000" oninput="syncFromSlider('p3-award', 'p3-award-num'); updateDisplay('p3'); updateAll()">
              <input type="number" class="param-input" id="p3-award-num" min="0" step="10000" value="50000" oninput="syncFromNumber('p3-award', 'p3-award-num'); updateDisplay('p3'); updateAll()">
            </div>

            <div class="param-group">
              <label class="param-label">Estimated Hours per Submission</label>
              <div class="param-value" id="p3-hours-display">15h</div>
              <input type="range" class="param-input" id="p3-hours" min="5" max="500" step="5" value="15" oninput="syncFromSlider('p3-hours', 'p3-hours-num'); updateDisplay('p3'); updateAll()">
              <input type="number" class="param-input" id="p3-hours-num" min="1" step="1" value="15" oninput="syncFromNumber('p3-hours', 'p3-hours-num'); updateDisplay('p3'); updateAll()">
            </div>

            <div class="param-group">
              <label class="param-label">Success Probability (%)</label>
              <div class="param-value" id="p3-prob-display">25%</div>
              <input type="range" class="param-input" id="p3-prob" min="1" max="100" step="1" value="25" oninput="syncFromSlider('p3-prob', 'p3-prob-num'); updateDisplay('p3'); updateAll()">
              <input type="number" class="param-input" id="p3-prob-num" min="0.1" max="100" step="0.1" value="25" oninput="syncFromNumber('p3-prob', 'p3-prob-num'); updateDisplay('p3'); updateAll()">
              <div class="param-hint">Honest estimate. Include competitive pressure.</div>
              <div class="calc-explanation" id="p3-calc"></div>
              <div class="breakeven-alert" id="p3-breakeven"></div>
            </div>

            <div class="param-group">
              <label class="param-label">Strategic Value Multiplier (1-3x)</label>
              <div class="param-value" id="p3-mult-display">1.0x</div>
              <input type="range" class="param-input" id="p3-mult" min="1" max="3" step="0.1" value="1.0" oninput="syncFromSlider('p3-mult', 'p3-mult-num'); updateDisplay('p3'); updateAll()">
              <input type="number" class="param-input" id="p3-mult-num" min="0.1" max="10" step="0.1" value="1.0" oninput="syncFromNumber('p3-mult', 'p3-mult-num'); updateDisplay('p3'); updateAll()">
              <div class="param-hint">Relationship building, leadership visibility, downstream grants?</div>
            </div>

            <div class="param-group">
              <label class="param-label">Max Attempts</label>
              <div class="param-value" id="p3-resubmit-display">2</div>
              <input type="range" class="param-input" id="p3-resubmit" min="1" max="10" step="1" value="2" oninput="syncFromSlider('p3-resubmit', 'p3-resubmit-num'); updateDisplay('p3'); updateAll()">
              <input type="number" class="param-input" id="p3-resubmit-num" min="1" step="1" value="2" oninput="syncFromNumber('p3-resubmit', 'p3-resubmit-num'); updateDisplay('p3'); updateAll()">
              <div class="param-hint">Total times you'd submit this (including the first attempt)</div>
              <div class="calc-explanation" id="p3-resubmit-calc"></div>
            </div>
          </div>
          <div style="margin-top: 16px; text-align: center;">
            <button id="recalculateBtn" onclick="updateAll()" style="padding: 10px 20px; background-color: #0d7377; color: white; border: none; border-radius: 4px; font-weight: 700; font-size: 13px; cursor: pointer; transition: background-color 0.2s;">
              ↻ Recalculate
            </button>
            <div style="font-size: 11px; color: #9ca3af; margin-top: 8px;">Click to manually update all results (auto-updates on input)</div>
          </div>
        </div>
      </div>

      <!-- RANKING TAB -->
      <div id="ranking" class="tab-content">
        <div class="key-insight">
          <strong>Portfolio Ranking Index:</strong> Proposals are ranked by <strong>effective commitment level</strong>—their value per hour per attempt, constrained by how many times you're actually willing to resubmit. A proposal you'll iterate 3 times ranks higher than one you'd only submit once, even if the per-attempt efficiency is lower.
        </div>

        <div class="ranking-index">
          <h3 style="margin-bottom: 16px; color: #0d7377;">Ranking by Effective Commitment</h3>
          <div id="ranking-table"></div>
          <div id="szilard-analysis"></div>
        </div>

        <div class="portfolio-summary">
          <h3>Portfolio Composition</h3>

          <div class="portfolio-chart-container">
            <h4>Annual Time Allocation by Tier</h4>
            <canvas id="portfolioChart"></canvas>
            <div class="chart-legend" id="chart-legend"></div>
          </div>

          <div class="portfolio-grid" id="portfolio-summary"></div>
        </div>
      </div>

      <!-- GUIDANCE TAB -->
      <div id="guidance" class="tab-content">
        <div class="key-insight">
          <strong>Submission Strategy:</strong> Each proposal is assigned to a tier based on efficiency, strategic value, and your actual commitment level (max attempts). This determines your submission strategy.
        </div>

        <div id="tier-guidance"></div>
      </div>

      <!-- GUIDE TAB -->
      <div id="framework" class="tab-content">
        <div class="framework-section">
          <h3>Guide</h3>

          <div class="key-insight">
            <strong>What this tool does:</strong> It ranks your grant proposals by comparing their expected value per hour against your personal target threshold. Proposals that return ≥3× your target are "Core" (pursue aggressively), ≥1× are "Opportunistic" (worth doing), >0 are "Exploratory" (low priority), and zero or negative are "Skip".
          </div>

          <h4 style="color: #0d7377; margin-top: 24px; margin-bottom: 12px; font-size: 14px; font-weight: 700;">How to Use It</h4>
          
          <div style="background: #f8f9fa; padding: 16px; border-radius: 4px; margin-bottom: 16px;">
            <p style="margin-bottom: 12px; font-size: 13px;"><strong>Step 1: Set your target hourly value</strong> — What's your time worth? This is your threshold for deciding if a grant is worth pursuing. Consider what you could earn consulting, or what hourly rate would make grant-writing feel worthwhile.</p>
            <p style="margin-bottom: 12px; font-size: 13px;"><strong>Step 2: Set your time budget</strong> — How many hours per year can you allocate to grant writing? The tool uses this to check if your portfolio fits your capacity.</p>
            <p style="margin-bottom: 12px; font-size: 13px;"><strong>Step 3: Enter proposal details</strong> — For each grant: award amount, hours to write it, your estimated success probability, any strategic multiplier, and how many times you'd realistically submit.</p>
            <p style="font-size: 13px;"><strong>Step 4: Read the results</strong> — Check the Submission Strategy tab for personalised guidance explaining exactly why each proposal got its tier.</p>
          </div>

          <h4 style="color: #0d7377; margin-top: 24px; margin-bottom: 12px; font-size: 14px; font-weight: 700;">Understanding the Tiers</h4>
          
          <div style="background: #f0f9f8; border-left: 4px solid #0d7377; padding: 12px; border-radius: 4px; margin-bottom: 16px;">
            <p style="font-size: 13px; margin: 0;"><strong>Important:</strong> Tiers are based on the ratio of EV/hour to <em>your</em> target hourly value. The target is something you set — it's not a universal truth. A higher target means fewer proposals will qualify as Core; a lower target means more will. Adjust it to reflect what your time is genuinely worth to you.</p>
          </div>

          <table style="width: 100%; margin-bottom: 20px;">
            <thead>
              <tr style="background: #f8f9fa; border-bottom: 2px solid #e5e7eb;">
                <th style="padding: 12px; text-align: left; font-weight: 700;">Tier</th>
                <th style="padding: 12px; text-align: left; font-weight: 700;">Ratio Threshold</th>
                <th style="padding: 12px; text-align: left; font-weight: 700;">What It Means</th>
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid #e5e7eb; background: #f7fdfb;">
                <td style="padding: 12px;"><span class="tier-badge core">CORE</span></td>
                <td style="padding: 12px;">≥ 3× your target</td>
                <td style="padding: 12px;">Excellent return — at least 3× what you consider worthwhile. Pursue aggressively, resubmit if rejected.</td>
              </tr>
              <tr style="border-bottom: 1px solid #e5e7eb; background: #f0f9f8;">
                <td style="padding: 12px;"><span class="tier-badge opportunistic">OPPORTUNISTIC</span></td>
                <td style="padding: 12px;">≥ 1× your target</td>
                <td style="padding: 12px;">Meets your threshold — worth your time. Submit, but don't over-invest in resubmissions.</td>
              </tr>
              <tr style="border-bottom: 1px solid #e5e7eb; background: #fffbf7;">
                <td style="padding: 12px;"><span class="tier-badge exploratory">EXPLORATORY</span></td>
                <td style="padding: 12px;">≥ 0.1× your target</td>
                <td style="padding: 12px;">Below your threshold but not negligible. Submit once for learning or relationship-building.</td>
              </tr>
              <tr style="background: #fff5f5;">
                <td style="padding: 12px;"><span class="tier-badge skip">SKIP</span></td>
                <td style="padding: 12px;">< 0.1× your target</td>
                <td style="padding: 12px;">Less than 10% of your threshold — not worth your time. Don't pursue.</td>
              </tr>
            </tbody>
          </table>

          <h4 style="color: #0d7377; margin-top: 24px; margin-bottom: 12px; font-size: 14px; font-weight: 700;">The Formulas</h4>

          <table style="width: 100%; margin-bottom: 20px;">
            <tbody>
              <tr style="border-bottom: 1px solid #e5e7eb;">
                <td style="padding: 12px; width: 40%;"><strong>Expected Value (EV)</strong></td>
                <td style="padding: 12px; font-family: 'Courier New', monospace;">= Award × Probability</td>
              </tr>
              <tr style="border-bottom: 1px solid #e5e7eb;">
                <td style="padding: 12px;"><strong>EV per Hour</strong></td>
                <td style="padding: 12px; font-family: 'Courier New', monospace;">= EV ÷ Hours per submission</td>
              </tr>
              <tr style="border-bottom: 1px solid #e5e7eb;">
                <td style="padding: 12px;"><strong>Ratio</strong></td>
                <td style="padding: 12px; font-family: 'Courier New', monospace;">= EV per Hour ÷ Your target hourly value</td>
              </tr>
              <tr style="border-bottom: 1px solid #e5e7eb;">
                <td style="padding: 12px;"><strong>Expected Attempts</strong></td>
                <td style="padding: 12px; font-family: 'Courier New', monospace;">= 1 ÷ Probability</td>
              </tr>
              <tr>
                <td style="padding: 12px;"><strong>Effective Commitment</strong></td>
                <td style="padding: 12px; font-family: 'Courier New', monospace;">= Min(Expected Attempts, Max Attempts)</td>
              </tr>
            </tbody>
          </table>

          <h4 style="color: #0d7377; margin-top: 24px; margin-bottom: 12px; font-size: 14px; font-weight: 700;">Tips for Estimating Inputs</h4>

          <div class="tips-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
            <div style="background: #f8f9fa; padding: 16px; border-radius: 4px; border-left: 4px solid #0d7377;">
              <p style="font-weight: 700; margin-bottom: 8px; font-size: 13px;">Success Probability</p>
              <p style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">Be honest. Most grants have 10-25% success rates. Check funder statistics if available.</p>
              <p style="font-size: 12px; color: #6b7280;">Consider: competition level, your track record with this funder, fit with their priorities.</p>
            </div>
            <div style="background: #f8f9fa; padding: 16px; border-radius: 4px; border-left: 4px solid #0d7377;">
              <p style="font-weight: 700; margin-bottom: 8px; font-size: 13px;">Hours per Submission</p>
              <p style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">Include everything: reading guidelines, drafting, revisions, gathering letters, admin.</p>
              <p style="font-size: 12px; color: #6b7280;">Small grants: 10-30h. Standard grants: 40-80h. Large/complex: 100-500h+.</p>
            </div>
            <div style="background: #f8f9fa; padding: 16px; border-radius: 4px; border-left: 4px solid #0d7377;">
              <p style="font-weight: 700; margin-bottom: 8px; font-size: 13px;">Strategic Multiplier</p>
              <p style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">This captures intangible benefits beyond the money. A grant might be worth more than its face value if it brings prestige, visibility, or opens doors.</p>
              <p style="font-size: 12px; color: #6b7280;"><strong>1.0×</strong> = money only. <strong>1.5×</strong> = some added prestige/visibility. <strong>2-3×</strong> = significant career or reputational benefit (e.g., a fellowship that signals leadership).</p>
            </div>
            <div style="background: #f8f9fa; padding: 16px; border-radius: 4px; border-left: 4px solid #0d7377;">
              <p style="font-weight: 700; margin-bottom: 8px; font-size: 13px;">Max Attempts</p>
              <p style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">Total times you'd submit this proposal, including the first attempt. 1 = one-shot only.</p>
              <p style="font-size: 12px; color: #6b7280;">Be realistic — this affects your time budget. Don't say 5 if you'd actually quit after 2.</p>
            </div>
          </div>

          <div style="background: #fff3e0; border-left: 4px solid #ff8c42; padding: 16px; border-radius: 4px; margin-top: 24px;">
            <p style="font-weight: 700; margin-bottom: 8px; font-size: 13px;">Remember</p>
            <p style="font-size: 12px; color: #6b7280;">This tool helps you think systematically, but it's not a substitute for judgment. A "Skip" tier proposal might still be worth pursuing for reasons the model can't capture. Use the tiers as a starting point for prioritisation, not a rigid rule.</p>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <p>Grant Portfolio Evaluator: Rank proposals by effective commitment (EV/hr based on your target threshold)</p>
      <p>Core = pursue aggressively. Opportunistic = worth doing. Exploratory = low priority. Skip = don't pursue.</p>
      <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.2);">
        <p style="font-size: 14px; margin-bottom: 10px;">Created by <strong style="font-size: 15px;">James McInerney</strong></p>
        <a href="https://github.com/mol-evol" target="_blank" rel="noopener noreferrer" style="display: inline-block; padding: 8px 16px; background: rgba(255,255,255,0.1); color: white; text-decoration: none; border-radius: 4px; font-size: 13px; font-weight: 600; border: 1px solid rgba(255,255,255,0.3); transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.borderColor='rgba(255,255,255,0.5)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='rgba(255,255,255,0.3)'">
          GitHub: mol-evol — More Software
        </a>
      </div>
    </footer>
  </div>

  <script>
    function formatCurrency(val) {
      const currency = document.getElementById('currencySelect').value;
      val = Math.round(val);
      if (val >= 1000000) return currency + (val / 1000000).toFixed(1) + 'M';
      if (val >= 1000) return currency + (val / 1000).toFixed(0) + 'k';
      return currency + val;
    }

    function formatHourlyRate(val) {
      const currency = document.getElementById('currencySelect').value;
      return currency + (val / 1000).toFixed(2) + 'k';
    }

    function getCommitmentStatusMessage(commitmentPercent, totalAllocated, grantWritingPercent, totalCapacity, allocatedProposals, cutOffProposals, totalRequested) {
      const remaining = totalCapacity - totalAllocated;
      
      if (totalRequested > totalCapacity) {
        const overBy = totalRequested - totalCapacity;
        
        // Build list of what fits
        const fitsList = allocatedProposals
          .filter(p => !p.partial)
          .map(p => `${p.name} (${p.hours}h)`)
          .join(', ');
        
        // Build list of what's cut or partial
        let cutInfo = '';
        if (cutOffProposals.length > 0) {
          const cutDetails = cutOffProposals.map(p => {
            if (p.allocated > 0) {
              return `${p.name} (only ${p.allocated}h of ${p.ideal}h)`;
            } else {
              return `${p.name} (${p.ideal}h — entirely cut)`;
            }
          }).join(', ');
          cutInfo = `<br><strong>Won't fit:</strong> ${cutDetails}`;
        }
        
        return `<div style="grid-column: 1 / -1; background: #ffebee; border-left: 3px solid #d32f2f; padding: 12px; border-radius: 4px; font-size: 12px; color: #1a1a1a; margin-top: 8px;">
          <strong>🚨 Over budget by ${overBy}h.</strong> You need ${totalRequested}h but only have ${totalCapacity}h allocated.
          <br><strong>Fits within budget:</strong> ${fitsList || 'None fully'}${cutInfo}
          <br><em style="color: #666; font-size: 11px;">Either increase your grant writing %, reduce hours per proposal, or drop a proposal.</em>
        </div>`;
      } else if (commitmentPercent > 90) {
        return `<div style="grid-column: 1 / -1; background: #fff3e0; border-left: 3px solid #ff8c42; padding: 8px; border-radius: 4px; font-size: 11px; color: #1a1a1a; margin-top: 8px;">
          <strong>⚠ Near capacity:</strong> You're using ${commitmentPercent}% of your allocated grant writing time. Only ${remaining}h left for revisions and resubmissions.
        </div>`;
      }
      
      return `<div style="grid-column: 1 / -1; background: #e8f5e9; border-left: 3px solid #388e3c; padding: 8px; border-radius: 4px; font-size: 11px; color: #1a1a1a; margin-top: 8px;">
        <strong>✓ Balanced portfolio:</strong> Using ${commitmentPercent}% of your ${grantWritingPercent}% allocation. ${remaining}h available for revisions and new opportunities.
      </div>`;
    }

    // Number input is source of truth; slider clamps to its range
    function syncFromNumber(rangeId, numId) {
      const slider = document.getElementById(rangeId);
      const val = parseFloat(document.getElementById(numId).value) || 0;
      // Clamp slider to its min/max, but don't change the number
      const clamped = Math.min(Math.max(val, parseFloat(slider.min)), parseFloat(slider.max));
      slider.value = clamped;
    }

    function syncFromSlider(rangeId, numId) {
      const val = document.getElementById(rangeId).value;
      document.getElementById(numId).value = val;
    }

    function updateDisplay(prop) {
      // Always read from number inputs (source of truth)
      const award = parseFloat(document.getElementById(prop + '-award-num').value) || 0;
      const hours = parseFloat(document.getElementById(prop + '-hours-num').value) || 0;
      const prob = parseFloat(document.getElementById(prop + '-prob-num').value) || 0;
      const mult = parseFloat(document.getElementById(prop + '-mult-num').value) || 1;
      const resubmit = parseFloat(document.getElementById(prop + '-resubmit-num').value) || 1;

      const currency = document.getElementById('currencySelect').value;
      
      document.getElementById(prop + '-award-display').textContent = formatCurrency(award);
      document.getElementById(prop + '-currency-label').textContent = currency;
      document.getElementById(prop + '-hours-display').textContent = Math.round(hours) + 'h';
      document.getElementById(prop + '-prob-display').textContent = Math.round(prob) + '%';
      document.getElementById(prop + '-mult-display').textContent = mult.toFixed(1) + 'x';
      document.getElementById(prop + '-resubmit-display').textContent = Math.round(resubmit);

      // Show calculation for expected attempts
      const expectedAttempts = prob > 0 ? Math.round(1 / (prob / 100)) : 999;
      document.getElementById(prop + '-calc').innerHTML = `<strong>Expected Attempts:</strong> 1 ÷ ${Math.round(prob)}% = ${expectedAttempts} submissions`;

      // Show calculation for effective commitment
      const effectiveCommitment = Math.min(expectedAttempts, Math.round(resubmit));
      document.getElementById(prop + '-resubmit-calc').innerHTML = `<strong>Effective Commitment:</strong> Min(${expectedAttempts} expected, ${Math.round(resubmit)} max) = <strong>${effectiveCommitment}</strong> attempts`;

      // Szilard threshold will be calculated in updateAll, not here
      // Just clear the element for now
      const breakEvenEl = document.getElementById(prop + '-breakeven');
      breakEvenEl.innerHTML = '';
    }

    function getProposal(num) {
      return {
        name: document.getElementById('p' + num + '-name').value || `Proposal ${num}`,
        award: parseFloat(document.getElementById('p' + num + '-award-num').value) || 0,
        hours: parseFloat(document.getElementById('p' + num + '-hours-num').value) || 0,
        prob: (parseFloat(document.getElementById('p' + num + '-prob-num').value) || 0) / 100,
        mult: parseFloat(document.getElementById('p' + num + '-mult-num').value) || 1,
        resubmit: parseFloat(document.getElementById('p' + num + '-resubmit-num').value) || 1
      };
    }

    function calculate(prop) {
      const { award, hours, prob, mult, resubmit } = prop;
      const ev = award * prob;
      const evPerHour = hours > 0 ? ev / hours : 0;
      const expectedAttempts = prob > 0 ? Math.round(1 / prob) : 999;
      const effectiveCommitment = Math.min(expectedAttempts, Math.round(resubmit));
      
      // Ranking is now based purely on EV/Hour (no division by commitment)
      // Commitment only affects budget allocation and tier signals
      const rankingEvPerHour = evPerHour;
      
      return { ev, evPerHour, expectedAttempts, effectiveCommitment, rankingEvPerHour };
    }

    function getTier(evPerHour, targetHourlyValue) {
      const ratio = targetHourlyValue > 0 ? evPerHour / targetHourlyValue : 0;
      if (ratio >= 3) return 'core';
      if (ratio >= 1) return 'opportunistic';
      if (ratio >= 0.1) return 'exploratory';
      return 'skip';
    }

    function updateAll() {
      // Update all proposal displays to reflect currency change
      updateDisplay('p1');
      updateDisplay('p2');
      updateDisplay('p3');

      const props = [
        getProposal(1),
        getProposal(2),
        getProposal(3)
      ];

      const totalResearchHours = parseInt(document.getElementById('totalResearchHours').value) || 2000;
      const grantWritingPercent = parseInt(document.getElementById('grantWritingPercent').value) || 20;
      const TOTAL_CAPACITY = Math.round(totalResearchHours * (grantWritingPercent / 100));
      const targetHourlyValue = parseInt(document.getElementById('targetHourlyValue').value) || 1500;

      // Update currency symbol display
      const currency = document.getElementById('currencySelect').value;
      document.getElementById('targetCurrencySymbol').textContent = currency;

      // Update display of grant hours
      document.getElementById('grantHoursDisplay').textContent = `= ${TOTAL_CAPACITY} h/year`;

      const calcs = props.map(p => calculate(p));
      const tiers = calcs.map(c => getTier(c.evPerHour, targetHourlyValue));

      // Ranking table - sort by EFFECTIVE EV/hour
      const ranked = props.map((p, i) => ({
        ...p,
        ...calcs[i],
        tier: tiers[i],
        index: i + 1
      })).sort((a, b) => b.rankingEvPerHour - a.rankingEvPerHour);

      let rankingHtml = '';
      ranked.forEach((prop, rank) => {
        rankingHtml += `
          <div class="ranking-row ${prop.tier}">
            <div class="ranking-number">#${rank + 1}</div>
            <div class="ranking-name"><strong>${prop.name}</strong></div>
            <div class="ranking-metric">
              <div class="ranking-metric-label">EV/Hour</div>
              <div class="ranking-metric-value">${formatHourlyRate(prop.rankingEvPerHour)}</div>
            </div>
            <div class="ranking-metric">
              <div class="ranking-metric-label">Expected</div>
              <div class="ranking-metric-value">${prop.expectedAttempts}</div>
            </div>
            <div class="ranking-metric">
              <div class="ranking-metric-label">Your Commitment</div>
              <div class="ranking-metric-value">${prop.effectiveCommitment}</div>
            </div>
            <div class="ranking-metric">
              <div class="ranking-metric-label">Time Budget</div>
              <div class="ranking-metric-value">${Math.round(prop.hours * prop.effectiveCommitment)}h</div>
            </div>
            <div class="tier-tag ${prop.tier}">${prop.tier.toUpperCase()}</div>
          </div>
        `;
      });

      document.getElementById('ranking-table').innerHTML = rankingHtml;

      // Add Szilard threshold analysis
      let szilardHtml = '<div style="margin-top: 20px; background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">';
      szilardHtml += '<h4 style="color: #0d7377; margin-bottom: 12px; font-size: 13px; font-weight: 700;">Szilard Threshold Analysis (EV/Hour vs Your Target Value: ' + formatHourlyRate(targetHourlyValue) + '/hr)</h4>';
      szilardHtml += '<div style="font-size: 12px; line-height: 1.5;">';
      
      ranked.forEach((prop, rank) => {
        const meetsThreshold = prop.rankingEvPerHour >= targetHourlyValue;
        const statusIcon = meetsThreshold ? '✓' : '✗';
        const statusColor = meetsThreshold ? '#388e3c' : '#d32f2f';
        const statusText = meetsThreshold ? 'ABOVE threshold' : 'BELOW threshold';
        
        szilardHtml += `
          <div style="display: grid; grid-template-columns: 30px 200px 150px 150px 150px; gap: 12px; padding: 8px; border-bottom: 1px solid #e5e7eb; align-items: center;">
            <div style="text-align: center; font-weight: 700; color: ${statusColor};">${statusIcon}</div>
            <div style="font-weight: 600;">${prop.name}</div>
            <div style="text-align: center;">
              <div style="font-size: 11px; color: #9ca3af; text-transform: uppercase;">EV/Hour</div>
              <div style="font-weight: 700; color: #0d7377;">${formatHourlyRate(prop.rankingEvPerHour)}</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 11px; color: #9ca3af; text-transform: uppercase;">Your Threshold</div>
              <div style="font-weight: 700; color: #0d7377;">${formatHourlyRate(targetHourlyValue)}</div>
            </div>
            <div style="text-align: center; padding: 4px 8px; border-radius: 4px; background: ${meetsThreshold ? '#e8f5e9' : '#ffebee'}; color: ${statusColor}; font-size: 11px; font-weight: 700;">
              ${statusText}
            </div>
          </div>
        `;
      });
      
      szilardHtml += '</div></div>';
      document.getElementById('szilard-analysis').innerHTML = szilardHtml;

      // Portfolio summary
      const coreTier = ranked.filter(p => p.tier === 'core');
      const oppTier = ranked.filter(p => p.tier === 'opportunistic');
      const expTier = ranked.filter(p => p.tier === 'exploratory');
      const skipTier = ranked.filter(p => p.tier === 'skip');

      let summaryHtml = `
        <div class="portfolio-item">
          <div class="portfolio-label">CORE PROPOSALS</div>
          <div class="portfolio-value">${coreTier.length}</div>
          <div class="portfolio-description">${coreTier.length > 0 ? coreTier.map(p => p.name).join(', ') : 'None identified'}</div>
        </div>

        <div class="portfolio-item opportunistic">
          <div class="portfolio-label">OPPORTUNISTIC PROPOSALS</div>
          <div class="portfolio-value">${oppTier.length}</div>
          <div class="portfolio-description">${oppTier.length > 0 ? oppTier.map(p => p.name).join(', ') : 'None identified'}</div>
        </div>

        <div class="portfolio-item exploratory">
          <div class="portfolio-label">EXPLORATORY PROPOSALS</div>
          <div class="portfolio-value">${expTier.length}</div>
          <div class="portfolio-description">${expTier.length > 0 ? expTier.map(p => p.name).join(', ') : 'None identified'}</div>
        </div>

        <div class="portfolio-item skip">
          <div class="portfolio-label">SKIP</div>
          <div class="portfolio-value">${skipTier.length}</div>
          <div class="portfolio-description">${skipTier.length > 0 ? skipTier.map(p => p.name).join(', ') : 'None'}</div>
        </div>
      `;

      document.getElementById('portfolio-summary').innerHTML = summaryHtml;

      // Create portfolio allocation chart - OPTION B: Capped at budget, top-down allocation
      let remainingCapacity = TOTAL_CAPACITY;
      let allocation = { core: 0, opportunistic: 0, exploratory: 0, skip: 0 };
      let allocatedProposals = [];
      let cutOffProposals = [];

      // Allocate top-down by ranking
      for (let i = 0; i < ranked.length; i++) {
        const prop = ranked[i];
        const hoursNeeded = prop.hours * prop.effectiveCommitment;

        if (remainingCapacity >= hoursNeeded) {
          // Can fit this proposal
          allocation[prop.tier] += hoursNeeded;
          remainingCapacity -= hoursNeeded;
          allocatedProposals.push({ name: prop.name, tier: prop.tier, hours: hoursNeeded, partial: false });
        } else if (remainingCapacity > 0 && prop.tier !== 'skip') {
          // Partial allocation (only if not skip tier)
          allocation[prop.tier] += remainingCapacity;
          allocatedProposals.push({ name: prop.name, tier: prop.tier, hours: remainingCapacity, partial: true, ideal: hoursNeeded });
          cutOffProposals.push({ name: prop.name, tier: prop.tier, allocated: remainingCapacity, ideal: hoursNeeded });
          remainingCapacity = 0;
          break;
        } else {
          // Can't fit - goes to cutoff list
          cutOffProposals.push({ name: prop.name, tier: prop.tier, allocated: 0, ideal: hoursNeeded });
        }
      }

      const totalAllocated = TOTAL_CAPACITY - remainingCapacity;
      
      // Calculate total hours requested across all proposals
      const totalRequested = ranked.reduce((sum, prop) => sum + (prop.hours * prop.effectiveCommitment), 0);

      // Create legend with allocation details and commitment analysis
      const commitmentPercent = totalAllocated > 0 ? Math.round((totalAllocated / TOTAL_CAPACITY) * 100) : 0;
      
      let legendHtml = `
        <div class="chart-legend-item">
          <div class="chart-legend-color core"></div>
          <div><strong>Core:</strong> ${allocation.core}h (${totalAllocated > 0 ? Math.round((allocation.core/totalAllocated)*100) : 0}%)</div>
        </div>
        <div class="chart-legend-item">
          <div class="chart-legend-color opportunistic"></div>
          <div><strong>Opportunistic:</strong> ${allocation.opportunistic}h (${totalAllocated > 0 ? Math.round((allocation.opportunistic/totalAllocated)*100) : 0}%)</div>
        </div>
        <div class="chart-legend-item">
          <div class="chart-legend-color exploratory"></div>
          <div><strong>Exploratory:</strong> ${allocation.exploratory}h (${totalAllocated > 0 ? Math.round((allocation.exploratory/totalAllocated)*100) : 0}%)</div>
        </div>
        <div class="chart-legend-item">
          <div style="color: #9ca3af; font-size: 12px;"><strong>Budget:</strong> ${TOTAL_CAPACITY}h (${grantWritingPercent}% of ${totalResearchHours}h) | <strong>Used:</strong> ${totalAllocated}h (${commitmentPercent}%)</div>
        </div>
      `;

      legendHtml += getCommitmentStatusMessage(commitmentPercent, totalAllocated, grantWritingPercent, TOTAL_CAPACITY, allocatedProposals, cutOffProposals, totalRequested);

      document.getElementById('chart-legend').innerHTML = legendHtml;

      // Destroy existing chart if it exists
      if (window.portfolioChartInstance) {
        window.portfolioChartInstance.destroy();
      }

      // Create new chart with allocated hours
      const ctx = document.getElementById('portfolioChart');
      if (ctx && totalAllocated > 0) {
        window.portfolioChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: [`Annual Time Allocation (capped at ${TOTAL_CAPACITY}h)`],
            datasets: [
              {
                label: 'Core',
                data: [allocation.core],
                backgroundColor: '#388e3c',
                borderRadius: 0,
                borderSkipped: false
              },
              {
                label: 'Opportunistic',
                data: [allocation.opportunistic],
                backgroundColor: '#0d7377',
                borderRadius: 0,
                borderSkipped: false
              },
              {
                label: 'Exploratory',
                data: [allocation.exploratory],
                backgroundColor: '#ff8c42',
                borderRadius: 0,
                borderSkipped: false
              },
              {
                label: 'Reserved',
                data: [remainingCapacity],
                backgroundColor: '#e5e7eb',
                borderRadius: 0,
                borderSkipped: false
              }
            ]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': ' + context.parsed.x + 'h';
                  }
                }
              }
            },
            scales: {
              x: {
                stacked: true,
                max: TOTAL_CAPACITY,
                ticks: {
                  callback: function(value) {
                    return value + 'h';
                  }
                }
              },
              y: {
                stacked: true,
                ticks: {
                  font: {
                    weight: 600
                  }
                }
              }
            }
          }
        });
      }

      // Guidance section - single template, ratio determines tier
      let guidanceHtml = '';
      
      const tierThresholds = { core: 3, opportunistic: 1, exploratory: 0.1 };
      const tierNames = { core: 'CORE', opportunistic: 'OPPORTUNISTIC', exploratory: 'EXPLORATORY', skip: 'SKIP' };
      const nextTier = { opportunistic: 'core', exploratory: 'opportunistic', skip: 'exploratory' };
      
      ranked.forEach((prop) => {
        const ratio = targetHourlyValue > 0 ? prop.evPerHour / targetHourlyValue : 0;
        const ratioDisplay = ratio.toFixed(1);
        const evDisplay = formatHourlyRate(prop.evPerHour);
        const targetDisplay = formatHourlyRate(targetHourlyValue);
        const budgetedHours = Math.round(prop.hours * prop.effectiveCommitment);
        const probPercent = Math.round(prop.prob * 100);
        
        // What would it take to reach next tier?
        let upgradeHint = '';
        if (nextTier[prop.tier]) {
          const needed = tierThresholds[nextTier[prop.tier]];
          const neededEv = needed * targetHourlyValue;
          upgradeHint = `To reach ${nextTier[prop.tier].toUpperCase()}, you'd need EV/hour ≥ ${formatHourlyRate(neededEv)} (${needed}× target).`;
        }
        
        const reasoning = `<strong>Why ${tierNames[prop.tier]}:</strong> EV/hour is ${evDisplay}, which is <strong>${ratioDisplay}× your ${targetDisplay}/hour target</strong>. ` +
          `At ${probPercent}% success probability, ~${prop.expectedAttempts} attempts expected. ` +
          `${prop.hours}h per submission × ${prop.effectiveCommitment} attempts = ${budgetedHours}h budgeted. ` +
          (upgradeHint ? `<br><br><em>${upgradeHint}</em>` : '');

        guidanceHtml += `
          <div class="grant-tier ${prop.tier}">
            <span class="tier-badge ${prop.tier}">${prop.tier.toUpperCase()}</span>
            <div class="tier-title">${prop.name}</div>
            <div class="tier-description">${reasoning}</div>
            <div class="tier-metrics">
              <div class="tier-metric">
                <div class="tier-metric-label">EV/Hour</div>
                <div class="tier-metric-value">${evDisplay}</div>
              </div>
              <div class="tier-metric">
                <div class="tier-metric-label">vs Target</div>
                <div class="tier-metric-value">${ratioDisplay}×</div>
              </div>
              <div class="tier-metric">
                <div class="tier-metric-label">Time Budget</div>
                <div class="tier-metric-value">${budgetedHours}h</div>
              </div>
            </div>
          </div>
        `;
      });

      document.getElementById('tier-guidance').innerHTML = guidanceHtml;
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
    }

    // Debounced update to prevent excessive recalculations
    let updateTimeout;
    function debouncedUpdate() {
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(updateAll, 300);
    }

    updateAll();

    // Event delegation for all inputs
    document.addEventListener('input', (e) => {
      if (e.target.id && (
        e.target.id.includes('award') || 
        e.target.id.includes('hours') || 
        e.target.id.includes('prob') || 
        e.target.id.includes('mult') || 
        e.target.id.includes('resubmit') ||
        e.target.id.includes('name') ||
        e.target.id === 'totalResearchHours' ||
        e.target.id === 'grantWritingPercent' ||
        e.target.id === 'targetHourlyValue'
      )) {
        debouncedUpdate();
      }
    });

    document.addEventListener('change', (e) => {
      if (e.target.id && (
        e.target.id.includes('award') || 
        e.target.id.includes('hours') || 
        e.target.id.includes('prob') || 
        e.target.id.includes('mult') || 
        e.target.id.includes('resubmit') ||
        e.target.id.includes('name') ||
        e.target.id === 'totalResearchHours' ||
        e.target.id === 'grantWritingPercent' ||
        e.target.id === 'targetHourlyValue' ||
        e.target.id === 'currencySelect'
      )) {
        updateAll();
      }
    });
  </script>
</body>
</html>
